language: android

android:
  components:
    - tools
    - platform-tools
    - build-tools-26.0.2
    - android-26
    - extra-android-m2repository
  licenses:
    - 'android-sdk-license-.+'
    - 'google-gdk-license-.+'
    - 'intel-android-extra-license-.+'

jdk:
  - oraclejdk8

branches:
  only:
    - master
    - 2.0

stages:
  - name: test
    if: type IN (push, pull_request)
  - name: snapshot
    if: type = push AND branch IN (master, 2.0)

before_install:
   # Untar secrets
   - openssl aes-256-cbc -K $encrypted_7f5144414b5d_key -iv $encrypted_7f5144414b5d_iv -in secrets.tar.enc -out secrets.tar -d
   - tar -xvf secrets.tar

   # Internal debug google services
   - mkdir -p app/src/internal/debug || true
   - cp secrets/internal-debug-google-services.json app/src/internal/debug/google-services.json

   # Internal release google services
   - mkdir -p app/src/internal/release || true
   - cp secrets/internal-release-google-services.json app/src/internal/release/google-services.json

   # Production release google services
   - mkdir -p app/src/production/release || true
   - cp secrets/production-release-google-services.json app/src/production/release/google-services.json

   # Video Android Twilio Credentials
   - cp secrets/twilio-video.json library/twilio-video.json

   # Video App Development Variant Credentials
   - cp secrets/twilio-video-app.json app/twilio-video-app.json

   # Authenticate with gcloud
   - gcloud auth activate-service-account travis@video-app-79418.iam.gserviceaccount.com --key-file=secrets/video-app-46437ca14fdd.json

before_script:
   # Gradle
   - echo "androidKeystore=$TRAVIS_BUILD_DIR/$ANDROID_KEYSTORE" >> $HOME/.gradle/gradle.properties
   - echo "androidKeystorePassword=$ANDROID_KEYSTORE_PASSWORD" >> $HOME/.gradle/gradle.properties
   - echo "androidReleaseKeyAlias=$ANDROID_RELEASE_KEY_ALIAS" >> $HOME/.gradle/gradle.properties
   - echo "androidReleaseKeyPassword=$ANDROID_RELEASE_KEY_PASSWORD" >> $HOME/.gradle/gradle.properties
   - echo "org.gradle.jvmargs=-Xmx4096M" >> $HOME/.gradle/gradle.properties

   # cmake
   - wget https://github.com/Commit451/android-cmake-installer/releases/download/1.1.0/install-cmake.sh
   - chmod +x install-cmake.sh
   - ./install-cmake.sh > /dev/null

   # Google Cloud SDK
   - if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi
   - source /home/travis/google-cloud-sdk/path.bash.inc
   - gcloud version

   # Android NDK Setup
   - pushd ~
   - wget -q https://dl.google.com/android/repository/android-ndk-r12b-linux-x86_64.zip
   - unzip -qo android-ndk-r12b-linux-x86_64.zip
   - export ANDROID_NDK_HOME="$HOME/android-ndk-r12b"
   - popd

cache:
  directories:
    - $HOME/.gradle
    - $HOME/google-cloud-sdk

jobs:
  include:
    - stage: test
      script: ./gradlew library:testDebugUnitTest
    - stage: test
      script: ./gradlew -q firebaseTestLabCheckLibrary
    - stage: test
      script: ./gradlew -q firebaseTestLabCheckLibraryCamera
    - stage: test
      script: ./gradlew -q assemble
    - stage: snapshot
      script: ./gradlew bintrayLibrarySnapshotUpload
    - stage: snapshot
      script: ./gradlew -PFirebaseServiceAccountFilePath=secrets/video-app-79418-firebase-crashreporting-4hlba-87d53fc37a.json app:firebaseUploadInternalReleaseProguardMapping
    - stage: snapshot
      script: ./gradlew app:uploadInternalReleaseToHockeyApp
